#!/bin/bash

# üéØ –ü–æ–ª–Ω—ã–π workflow —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞ —Å–∞–π—Ç–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./create_full_snapshot.sh DOMAIN DATE [MIN_SIZE]

DOMAIN="$1"
DATE="$2"
MIN_SIZE="${3:-5000}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ -z "$DOMAIN" ] || [ -z "$DATE" ]; then
    echo "üéØ –ü–æ–ª–Ω—ã–π workflow —Å–æ–∑–¥–∞–Ω–∏—è –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞ —Å–∞–π—Ç–∞"
    echo "=============================================================="
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 DOMAIN DATE [MIN_SIZE]"
    echo ""
    echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
    echo "  DOMAIN   - –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: sluga-narodu.com)"
    echo "  DATE     - —Ü–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYYMMDD (–Ω–∞–ø—Ä–∏–º–µ—Ä: 20191115)"
    echo "  MIN_SIZE - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –±–∞–π—Ç–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5000)"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  $0 sluga-narodu.com 20191115"
    echo "  $0 ba.org.ua 20200315 10000"
    echo ""
    echo "–†–µ–∑—É–ª—å—Ç–∞—Ç: –ü–æ–ª–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç –≤ –ø–∞–ø–∫–µ snapshots/DOMAIN/DATE/"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞—Ç—ã
if ! [[ "$DATE" =~ ^[0-9]{8}$ ]]; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ YYYYMMDD"
    echo "–ü—Ä–∏–º–µ—Ä: 20191115 (15 –Ω–æ—è–±—Ä—è 2019)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
if ! command -v curl >/dev/null 2>&1; then
    echo "‚ùå curl –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ curl –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

if ! command -v jq >/dev/null 2>&1; then
    echo "‚ùå jq –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ jq –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

if ! command -v python3 >/dev/null 2>&1; then
    echo "‚ùå python3 –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Python 3 –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è."
    exit 1
fi

echo "üéØ –°–û–ó–î–ê–ù–ò–ï –ü–û–õ–ù–û–ì–û –°–ù–ê–ü–®–û–¢–ê –°–ê–ô–¢–ê"
echo "=============================================================="
echo "üåê –î–æ–º–µ–Ω: $DOMAIN"
echo "üìÖ –¶–µ–ª–µ–≤–∞—è –¥–∞—Ç–∞: $DATE"
echo "üìè –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: $MIN_SIZE –±–∞–π—Ç"
echo ""

START_TIME=$(date +%s)

# ====================================================================
# –≠–¢–ê–ü 1: –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–∞ URL
# ====================================================================

echo "üîç –≠–¢–ê–ü 1/3: –°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–∞ URL"
echo "----------------------------------------------------------------------"

if [ -f "${DOMAIN}_master_list.json" ]; then
    echo "‚úÖ –ú–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${DOMAIN}_master_list.json"
    MASTER_COUNT=$(jq length "${DOMAIN}_master_list.json" 2>/dev/null || echo "0")
    echo "üìä URL –≤ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–µ: $MASTER_COUNT"

    read -p "ü§î –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üîÑ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫..."
        ./create_master_list.sh "$DOMAIN" "$MIN_SIZE"
    fi
else
    echo "üöÄ –°–æ–∑–¥–∞–µ–º –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫ URL..."
    if ! ./create_master_list.sh "$DOMAIN" "$MIN_SIZE"; then
        echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–∞"
        exit 1
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ ! -f "${DOMAIN}_master_list.json" ]; then
    echo "‚ùå –ú–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–æ–∫ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
    exit 1
fi

MASTER_COUNT=$(jq length "${DOMAIN}_master_list.json")
echo "‚úÖ –≠—Ç–∞–ø 1 –∑–∞–≤–µ—Ä—à–µ–Ω. URL –≤ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–µ: $MASTER_COUNT"
echo ""

# ====================================================================
# –≠–¢–ê–ü 2: –ü–æ–∏—Å–∫ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –¥–ª—è —Ü–µ–ª–µ–≤–æ–π –¥–∞—Ç—ã
# ====================================================================

echo "üìÖ –≠–¢–ê–ü 2/3: –ü–æ–∏—Å–∫ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –Ω–∞ –¥–∞—Ç—É $DATE"
echo "----------------------------------------------------------------------"

SNAPSHOTS_FILE="${DOMAIN}_snapshots_${DATE}.json"

if [ -f "$SNAPSHOTS_FILE" ]; then
    echo "‚úÖ –§–∞–π–ª —Å–Ω–∞–ø—à–æ—Ç–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $SNAPSHOTS_FILE"
    SNAPSHOTS_COUNT=$(jq length "$SNAPSHOTS_FILE" 2>/dev/null || echo "0")
    echo "üìä –ù–∞–π–¥–µ–Ω–Ω—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤: $SNAPSHOTS_COUNT"

    read -p "ü§î –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ —Å–Ω–∞–ø—à–æ—Ç–æ–≤? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "üîÑ –ò—â–µ–º —Å–Ω–∞–ø—à–æ—Ç—ã –∑–∞–Ω–æ–≤–æ..."
        ./find_snapshots_for_date.sh "$DOMAIN" "$DATE"
    fi
else
    # –í—ã–±–∏—Ä–∞–µ–º –æ–ø—Ç–∏–º–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–∏—Å–∫–∞
    if [ "$MASTER_COUNT" -gt 1000 ]; then
        echo "üöÄ –ë–æ–ª—å—à–æ–π —Å–∞–π—Ç ($MASTER_COUNT URL) - –∏—Å–ø–æ–ª—å–∑—É–µ–º –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ø–æ–∏—Å–∫..."
        if ! ./find_snapshots_for_date_optimized.sh "$DOMAIN" "$DATE"; then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ–∏—Å–∫–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤"
            exit 1
        fi
    else
        echo "üöÄ –û–±—ã—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Å–∞–π—Ç–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ–∏—Å–∫..."
        if ! ./find_snapshots_for_date.sh "$DOMAIN" "$DATE"; then
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤"
            echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: ./find_snapshots_for_date_optimized.sh $DOMAIN $DATE"
            exit 1
        fi
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ ! -f "$SNAPSHOTS_FILE" ]; then
    echo "‚ùå –§–∞–π–ª —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω"
    exit 1
fi

SNAPSHOTS_COUNT=$(jq length "$SNAPSHOTS_FILE")
if [ "$SNAPSHOTS_COUNT" -eq 0 ]; then
    echo "‚ùå –°–Ω–∞–ø—à–æ—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è –¥–∞—Ç—ã $DATE"
    echo "üí° –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö ¬±90 –¥–Ω–µ–π"
    exit 1
fi

echo "‚úÖ –≠—Ç–∞–ø 2 –∑–∞–≤–µ—Ä—à–µ–Ω. –ù–∞–π–¥–µ–Ω–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤: $SNAPSHOTS_COUNT"
echo ""

# ====================================================================
# –≠–¢–ê–ü 3: –ú–∞—Å—Å–æ–≤–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
# ====================================================================

echo "‚¨áÔ∏è  –≠–¢–ê–ü 3/3: –ú–∞—Å—Å–æ–≤–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞"
echo "----------------------------------------------------------------------"

SNAPSHOT_DIR="snapshots/${DOMAIN}/${DATE}"

if [ -d "$SNAPSHOT_DIR" ] && [ "$(ls -A "$SNAPSHOT_DIR" 2>/dev/null | wc -l)" -gt 0 ]; then
    echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–Ω–∞–ø—à–æ—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: $SNAPSHOT_DIR"
    EXISTING_FILES=$(find "$SNAPSHOT_DIR" -name "*.html" | wc -l)
    echo "üìä –£–∂–µ —Å–∫–∞—á–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $EXISTING_FILES"

    read -p "ü§î –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (resume mode)? (Y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Nn]$ ]]; then
        echo "‚è≠Ô∏è  –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–∞–ø —Å–∫–∞—á–∏–≤–∞–Ω–∏—è"
    else
        echo "üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ resume —Ä–µ–∂–∏–º–µ..."
        poetry run wayback-analyzer download-snapshot "$DOMAIN" --date "$DATE" --resume
    fi
else
    echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –º–∞—Å—Å–æ–≤–æ–µ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ..."
    poetry run wayback-analyzer download-snapshot "$DOMAIN" --date "$DATE"
fi

# ====================================================================
# –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê
# ====================================================================

END_TIME=$(date +%s)
TOTAL_DURATION=$((END_TIME - START_TIME))
TOTAL_MINUTES=$((TOTAL_DURATION / 60))

echo ""
echo "üéâ –ü–û–õ–ù–´–ô –°–ù–ê–ü–®–û–¢ –°–û–ó–î–ê–ù!"
echo "=============================================================="
echo "üìä –§–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:"
echo "  üåê –î–æ–º–µ–Ω: $DOMAIN"
echo "  üìÖ –î–∞—Ç–∞: $DATE"
echo "  üìÑ URL –≤ –º–∞—Å—Ç–µ—Ä-—Å–ø–∏—Å–∫–µ: $MASTER_COUNT"
echo "  üì∏ –ù–∞–π–¥–µ–Ω–æ —Å–Ω–∞–ø—à–æ—Ç–æ–≤: $SNAPSHOTS_COUNT"

if [ -d "$SNAPSHOT_DIR" ]; then
    DOWNLOADED_FILES=$(find "$SNAPSHOT_DIR" -name "*.html" 2>/dev/null | wc -l)
    TOTAL_SIZE=$(du -sh "$SNAPSHOT_DIR" 2>/dev/null | cut -f1)
    echo "  ‚¨áÔ∏è  –°–∫–∞—á–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: $DOWNLOADED_FILES"
    echo "  üíæ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: $TOTAL_SIZE"
    echo "  üìÅ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤: $SNAPSHOT_DIR"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–º–µ—Ä—ã —Ñ–∞–π–ª–æ–≤
    echo ""
    echo "üìã –ü—Ä–∏–º–µ—Ä—ã —Å–∫–∞—á–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤:"
    find "$SNAPSHOT_DIR" -name "*.html" | head -5 | while read file; do
        echo "  üìÑ $(basename "$file")"
    done

    if [ -f "$SNAPSHOT_DIR/snapshot_manifest.json" ]; then
        echo ""
        echo "üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤: $SNAPSHOT_DIR/snapshot_manifest.json"
    fi
fi

echo "  ‚è±Ô∏è  –û–±—â–µ–µ –≤—Ä–µ–º—è: $TOTAL_MINUTES –º–∏–Ω—É—Ç"
echo ""

# –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –¥–∞–ª—å–Ω–µ–π—à–µ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
echo "üöÄ –ß—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ:"
echo "  1. –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç: poetry run wayback-analyzer analyze-content $DOMAIN --date $DATE"
echo "  2. –°—Ä–∞–≤–Ω–∏—Ç—å —Å –¥—Ä—É–≥–∏–º–∏ –¥–∞—Ç–∞–º–∏: ./create_full_snapshot.sh $DOMAIN –î–†–£–ì–ê–Ø_–î–ê–¢–ê"
echo "  3. –ò–∑—É—á–∏—Ç—å —Ñ–∞–π–ª—ã –≤: $SNAPSHOT_DIR"
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–æ–ª–Ω—ã–π –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–π —Å–Ω–∞–ø—à–æ—Ç —Å–∞–π—Ç–∞ $DOMAIN –Ω–∞ $DATE —Å–æ–∑–¥–∞–Ω."